generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole { admin manager buyer logistics viewer }
enum ProcurementStatus { draft in_work submitted won lost canceled }
enum Currency { RUB }
enum LineItemSource { manual history ai }
enum PriceHistorySource { manual line_item import ai }
enum DocumentType { tz passport invoice other }
enum AiExtractionKind { passport_specs tz_requirements application_draft }

model User {
  id           String   @id @default(uuid())
  fullName     String
  email        String   @unique
  passwordHash String
  role         UserRole
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())

  procurements Procurement[]
}

model Procurement {
  id                 String            @id @default(uuid())
  title              String
  nmck               Decimal           @db.Decimal(14,2)
  responsibleUserId  String
  responsibleUser    User              @relation(fields: [responsibleUserId], references: [id])
  purchaseCostManual Decimal?          @db.Decimal(14,2)
  logisticsCost      Decimal           @default(0) @db.Decimal(14,2)
  otherServicesCost  Decimal           @default(0) @db.Decimal(14,2)
  deliveryLocation   String
  status             ProcurementStatus @default(draft)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  items      LineItem[]
  documents  Document[]
  histories  PriceHistory[]
}

model Supplier {
  id    String @id @default(uuid())
  name  String
  url   String?
  notes String?

  items     LineItem[]
  histories PriceHistory[]
}

model Product {
  id            String   @id @default(uuid())
  name          String
  normalizedKey String   @index
  brand         String?
  model         String?
  category      String?
  passportUrl   String?
  createdAt     DateTime @default(now())

  aliases   ProductAlias[]
  items     LineItem[]
  histories PriceHistory[]
}

model ProductAlias {
  id              String @id @default(uuid())
  productId       String
  product         Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  alias           String
  aliasNormalized String @index
}

model LineItem {
  id                  String         @id @default(uuid())
  procurementId       String
  procurement         Procurement    @relation(fields: [procurementId], references: [id], onDelete: Cascade)
  productId           String?
  product             Product?       @relation(fields: [productId], references: [id])
  nameSnapshot        String
  supplierId          String?
  supplier            Supplier?      @relation(fields: [supplierId], references: [id])
  supplierUrlSnapshot String?
  qty                 Decimal        @db.Decimal(12,3)
  unitPrice           Decimal        @db.Decimal(14,2)
  total               Decimal        @db.Decimal(14,2)
  currency            Currency       @default(RUB)
  source              LineItemSource @default(manual)
  notes               String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
}

model PriceHistory {
  id             String             @id @default(uuid())
  productId      String
  product        Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplierId     String
  supplier       Supplier           @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  unitPrice      Decimal            @db.Decimal(14,2)
  currency       Currency           @default(RUB)
  deliveryRegion String?
  procurementId  String?
  procurement    Procurement?       @relation(fields: [procurementId], references: [id])
  capturedAt     DateTime           @default(now())
  source         PriceHistorySource
}

model Document {
  id           String       @id @default(uuid())
  procurementId String
  procurement   Procurement  @relation(fields: [procurementId], references: [id], onDelete: Cascade)
  type         DocumentType
  filename     String
  mimeType     String
  storagePath  String
  textExtracted String?
  extractedAt  DateTime?
  createdAt    DateTime     @default(now())

  extractions  AiExtraction[]
}

model AiExtraction {
  id             String @id @default(uuid())
  documentId     String
  document       Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  kind           AiExtractionKind
  payloadJson    Json
  confidenceJson Json
  provider       String
  model          String
  createdAt      DateTime @default(now())
}
